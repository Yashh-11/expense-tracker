<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ExpenseHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <nav class="navbar bg-white shadow-sm mb-4">
        <div class="container">
            <span id="userName"></span>
            <button class="btn btn-outline-danger btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container">

        <form id="expenseForm" class="mb-3">
            <input type="hidden" id="editId">
            <div class="row g-2">
                <div class="col"><input id="name" class="form-control" placeholder="Expense name" required></div>
                <div class="col"><input type="number" id="amount" class="form-control" placeholder="₹ Amount" required>
                </div>
                <div class="col"><input type="date" id="date" class="form-control" required></div>
                <div class="col">
                    <select id="category" class="form-select" required>
                        <option value="">Category</option>
                        <option>Food</option>
                        <option>Travel</option>
                        <option>Bills</option>
                        <option>Shopping</option>
                        <option>Other</option>
                    </select>
                </div>
                <div class="col">
                    <button class="btn btn-success w-100">Save</button>
                </div>
            </div>
        </form>

        <div class="d-flex gap-3 mb-3">
            <select id="sortDate" class="form-select w-25">
                <option value="desc">Newest First</option>
                <option value="asc">Oldest First</option>
            </select>
            <select id="filter" class="form-select w-25">
                <option value="all">All Categories</option>
                <option>Food</option>
                <option>Travel</option>
                <option>Bills</option>
                <option>Shopping</option>
                <option>Other</option>
            </select>
        </div>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>₹</th>
                    <th>Date</th>
                    <th>Category</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

    </div>

    <script src="config.js"></script>
    <script>
        const user = getCurrentUser();
        if (!user) location.href = "login.html";
        document.getElementById("userName").textContent = `Hi, ${user.name}!`;

        let all = JSON.parse(localStorage.getItem("expenses-" + user.email) || "[]");

        function save() {
            localStorage.setItem("expenses-" + user.email, JSON.stringify(all));
        }

        function render() {
            let sort = document.getElementById("sortDate").value;
            let filter = document.getElementById("filter").value;

            let list = [...all];
            if (filter !== "all") list = list.filter(x => x.category === filter);
            list.sort((a, b) => sort === "asc" ? new Date(a.date) - new Date(b.date) : new Date(b.date) - new Date(a.date));

            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";

            list.forEach(e => {
                tbody.innerHTML += `
      <tr>
        <td>${e.name}</td><td>₹${e.amount}</td><td>${e.date}</td>
        <td>${e.category}</td>
        <td>
          <button class="btn btn-sm btn-primary" onclick='edit(${e.id})'>Edit</button>
          <button class="btn btn-sm btn-danger" onclick='del(${e.id})'>Del</button>
        </td>
      </tr>`;
            });
        }

        document.getElementById("expenseForm").addEventListener("submit", e => {
            e.preventDefault();
            let id = document.getElementById("editId").value;
            let obj = {
                id: id ? Number(id) : Date.now(),
                name: document.getElementById("name").value,
                amount: document.getElementById("amount").value,
                date: document.getElementById("date").value,
                category: document.getElementById("category").value
            };

            if (id) {
                all = all.map(x => x.id == id ? obj : x);
            } else all.push(obj);

            save();
            render();
            e.target.reset();
            document.getElementById("editId").value = "";
        });

        function edit(id) {
            const e = all.find(x => x.id == id);
            document.getElementById("editId").value = e.id;
            document.getElementById("name").value = e.name;
            document.getElementById("amount").value = e.amount;
            document.getElementById("date").value = e.date;
            document.getElementById("category").value = e.category;
        }

        function del(id) {
            if (!confirm("Sure?")) return;
            all = all.filter(x => x.id != id);
            save();
            render();
        }

        document.getElementById("sortDate").onchange = render;
        document.getElementById("filter").onchange = render;
        render();
    </script>

</body>

</html>